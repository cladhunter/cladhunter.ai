# Аудит Cladhunter

## Краткое резюме
- Серверная логика принимает публичный Supabase anon key и доверяет идентификатору пользователя, который клиент может прислать в заголовке `X-User-ID`, что позволяет полностью обойти авторизацию и лимиты, особенно в связке с опубликованным в бандле тестером API.【F:supabase/functions/server/index.tsx†L62-L127】【F:hooks/useApi.tsx†L21-L26】【F:App.tsx†L12-L12】【F:utils/test-api.ts†L6-L27】【F:utils/test-api.ts†L235-L249】
- Финансовые операции (бусты и партнерские награды) подтверждаются исключительно данными, присланными клиентом, из-за чего любой пользователь может без оплаты повышать множитель или начислять себе произвольное количество монет.【F:supabase/functions/server/index.tsx†L393-L452】【F:supabase/functions/server/index.tsx†L553-L599】
- Антифрод для рекламы реализован только на клиенте: сервер не проверяет факт просмотра ролика, а потому достаточно прямого запроса на `/ads/complete`, чтобы получать награды без взаимодействия с интерфейсом.【F:supabase/functions/server/index.tsx†L219-L293】【F:components/AdModal.tsx†L42-L176】

## Критические находки

### 1. Анонимные пользователи могут полностью имитировать любого клиента
**Риск.** Любой, кто знает публичный anon key (он зашит в бандл), может подставить произвольный `anon_*` идентификатор и вызывать все edge-функции как будто от имени настоящего пользователя, обходя лимиты и прокачивая баланс.【F:supabase/functions/server/index.tsx†L62-L127】【F:hooks/useApi.tsx†L21-L26】【F:utils/supabase/info.tsx†L1-L4】 Дополнительно в production-бандле лежит консольный тестер, который облегчает эксплуатацию без реверс-инжиниринга протокола.【F:App.tsx†L12-L12】【F:utils/test-api.ts†L6-L27】【F:utils/test-api.ts†L235-L249】 Благодаря CORS `origin: "*"` злоумышленник может обращаться к API из любого домена.【F:supabase/functions/server/index.tsx†L117-L127】

**Последствия.** Лимит в 200 просмотров/день и 30‑секундный кулдаун проверяются только по `user_id`, поэтому атакующий может генерировать неограниченное количество новых `anon_*` аккаунтов и «майнить» бесконечную валюту или сливать баланс других анонимных пользователей, угадав их идентификатор.

**Рекомендации.**
- Перейти на серверную генерацию и подпись анонимных токенов (например, выписывать JWT c приватным ключом и хранить `anon`-пользователя в Supabase Auth).
- Убрать `window.testApi` из production-бандла, оставив утилиту только в dev-сборке через условный импорт.
- Ограничить CORS известными доменами фронтенда и добавить rate limiting.

### 2. Клиент диктует размеры партнерских наград
**Риск.** Эндпоинт `/rewards/claim` принимает `reward_amount` и `partner_name` напрямую из тела запроса и без проверки записывает эти данные в KV, попутно увеличивая баланс пользователя.【F:supabase/functions/server/index.tsx†L553-L599】 Клиент может отправить любое число (например, миллион) и мгновенно зачислить его себе.

**Последствия.** Полный обход экономики и потенциальный вывод средств, если баланс привязан к реальной валюте.

**Рекомендации.**
- Хранить конфигурацию наград на сервере (например, загружать из `config/partners.ts`) и игнорировать данные из запроса.
- Логировать и тревожить подозрительные попытки, добавить idempotency.

### 3. Бусты активируются без проверки оплаты
**Риск.** После создания заказа достаточно POST на `/orders/{id}/confirm`, чтобы статус заказа стал `paid`, а пользователю выдали новый уровень буста; при этом `tx_hash` заполняется заглушкой, а проверка транзакции помечена как TODO.【F:supabase/functions/server/index.tsx†L393-L452】

**Последствия.** Любой пользователь может активировать самый дорогой буст без оплаты и держать повышенный множитель бесконечно.

**Рекомендации.**
- Интегрировать webhook TON и проверку транзакций до смены статуса заказа.
- Ограничить ручное подтверждение админскими ключами или вынести в отдельную защищенную функцию.

## Высокий риск злоупотреблений

### 4. Награда за рекламу полностью контролируется клиентом
**Наблюдение.** Модальное окно рекламы лишь ждёт `skipDelay` и вызывает `onAdCompleted`, после чего фронтенд обращается к `/ads/complete`. Сервер не сверяет, что пользователь действительно смотрел конкретный ролик или сколько времени прошло, и сразу повышает баланс.【F:components/AdModal.tsx†L42-L176】【F:supabase/functions/server/index.tsx†L219-L293】

**Последствия.** Достаточно скрипта с повторяющимися запросами для добычи монет без фактического просмотра рекламы; в комбинации с находкой №1 защита практически отсутствует.

**Рекомендации.**
- Добавить на сервере проверку подписи/токена, выдаваемого после просмотра (например, через сторонний ad-network webhook).
- Хранить и верифицировать идентификатор креатива, а не принимать любой `ad_id`.

## Средний приоритет

- Экономические настройки (`BOOSTS`, лимиты) дублируются в фронтенде и бэкенде, что гарантирует расхождение при будущих изменениях и облегчает манипуляции со стороны клиента.【F:supabase/functions/server/index.tsx†L38-L55】【F:config/economy.ts†L1-L33】 Вынесите единый источник правды и делитесь только необходимыми данными.
- Логи ограничиваются `console.log` внутри edge-функций, отсутствует централизованное наблюдение и алертинг. Рассмотрите использование Supabase Logs/Observability и структурированные сообщения, чтобы быстрее реагировать на аномалии.

## Низкий приоритет

- Telegram- и TON-интеграция пока не сопровождаются обработкой ошибок на фронтенде (пример: `sendTransaction` ловит ошибку, но не даёт пользователю подробностей), стоит расширить UX и телеметрию для реальных пользователей.【F:components/WalletScreen.tsx†L52-L119】
- Для кросс-платформенной работы мини-приложения имеет смысл вынести расчёт safe area/viewport на уровень утилит и добавить unit-тесты на хуки состояния.
